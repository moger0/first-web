{% extends 'myhome/index.html' %}
{% block head %}
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0, user-scalable=0">

        <title>地址管理</title>

         <link href="/static/myhome/img/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
      <link href="/static/myhome/img/favicon.ico" rel="icon" type="image/x-icon">
    <!-- Bootstrap -->
    <link href="/static/myhome/css/bootstrap.min.css" rel="stylesheet">
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="/static/myhome/js/jquery-1.12.4.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/static/myhome/js/bootstrap.min.js"></script>

        <link rel="stylesheet" type="text/css" href="/static/myhome/css/global.css">
        <link rel="stylesheet" type="text/css" href="/static/myhome/css/app.css">
        <script type="text/javascript" src="/static/myhome/js/rem.js"></script>
        <script type="text/javascript" src="/static/myhome/js/topNav.js"></script>

        <link href="/static/myhome/AmazeUI-2.4.2/assets/css/admin.css" rel="stylesheet" type="text/css">
        <link href="/static/myhome/AmazeUI-2.4.2/assets/css/amazeui.css" rel="stylesheet" type="text/css">

        <link href="/static/myhome/css/personal.css" rel="stylesheet" type="text/css">
        <link href="/static/myhome/css/addstyle.css" rel="stylesheet" type="text/css">
        <script src="/static/myhome/AmazeUI-2.4.2/assets/js/jquery.min.js" type="text/javascript"></script>


        <link href="/static/myhome/css/jsstyle.css" rel="stylesheet" type="text/css" />
        <script src="/static/myhome/AmazeUI-2.4.2/assets/js/amazeui.js"></script>
{% endblock %}      
{% block cont %}
        <div class="center" style="margin-top:80px">
            <div class="col-main">
                <div class="main-wrap" style="margin-bottom:30px">

                    <div class="user-address">
                        <!--标题 -->
                        <div class="am-cf am-padding">
                            <div class="am-fl am-cf"><strong class="am-text-danger am-text-lg">地址管理</strong> / <small>Address&nbsp;list</small></div>
                        </div>
                        <hr/>
                        <ul class="am-avg-sm-1 am-avg-md-3 am-thumbnails" id='ul'>
<!--                            <li class="user-addresslist hidden" data='hidden'>
                                <div class="address-left">
                                    <div class="user DefaultAddr">
                                        <span class="buy-address-detail">   
                                        <span class="buy-user">{{i.name}} </span>
                                        <span class="buy-phone"></span>
                                        </span>
                                    </div>
                                    <div class="default-address DefaultAddr">
                                        <span class="buy-line-title buy-line-title-type">收货地址：</span>
                                        <span class="buy--address-detail">
                                        <span class="province">{{i.sheng}} </span>
                                        <span class="city">{{i.shi}} </span>
                                        <span class="dist">{{i.xq}} </span>
                                        <span class="street">{{i.info}}</span>
                                        </span>

                                        </span>
                                    </div>
                                </div>
                                <div class="address-right">
                                    <span class="am-icon-angle-right am-icon-lg"></span>
                                </div>
                                <div class="clear"></div>

                                <div class="new-addr-btn">
                                    <a href="#">编辑</a>
                                    <span class="new-addr-bar">|</span>
                                    <a href="javascript:void(0);" class="deladdress" >删除</a>
                                </div>
                            </li> -->
                            {% for i in ob %}
                            <li class="user-addresslist {% if i.isselect == 1 %}defaultAddr{% endif %}" data="{{i.id}}">
                                <span class="new-option-r"><i class="am-icon-check-circle"></i>{% if i.isselect == 1 %}默认地址{% else %}设为默认{% endif %}</span>
                                <p class="new-tit new-p-re">
                                    <span class="new-txt">{{i.name}}</span>
                                    <span class="buy-phone">{{i.phone}}</span>
                                </p>
                                <div class="new-mu_l2a new-p-re">
                                    <p class="new-mu_l2cw">
                                        <span class="title">地址：</span>
                                        <span class="province">{{i.sheng}}</span>
                                        <span class="city">{{i.shi}}</span>
                                        <span class="dist">{{i.xq}}</span>
                                        <span class="street">{{i.info}}</span></p>
                                </div>
                                <div class="new-addr-btn">
                                    <a href="javascript:void(0);" class="editaddress"><i class="am-icon-edit"></i>编辑</a>
                                    <span class="new-addr-bar">|</span>
                                    <a href="javascript:void(0);" class="deladdress" ><i class="am-icon-trash "></i>删除</a>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                        <div class="clear"></div>
                        <a class="new-abtn-type" data-am-modal="{target: '#doc-modal-1', closeViaDimmer: 0}">添加新地址</a>
                        <!--例子-->
                        <div class="am-modal am-modal-no-btn" id="doc-modal-1">

                            <div class="add-dress">

                                <!--标题 -->
                                <div class="am-cf am-padding">
                                    <div class="am-fl am-cf"><strong class="am-text-danger am-text-lg">新增地址</strong> / <small>Add&nbsp;address</small></div>
                                </div>
                                <hr/>

                                <div class="am-u-md-12 am-u-lg-8" style="margin-top: 20px;">
                                    <form class="am-form am-form-horizontal" method='post'>

                                        <div class="am-form-group">
                                            <label for="user-name" class="am-form-label">收货人</label>
                                            <div class="am-form-content">
                                                <input type="text" id="username" placeholder="收货人">
                                            </div>
                                        </div>

                                        <div class="am-form-group">
                                            <label for="user-phone" class="am-form-label">手机号码</label>
                                            <div class="am-form-content">
                                                <input id="user-phone" placeholder="手机号必填" type="email">
                                            </div>
                                        </div>
                                        <div class="am-form-group">
                                            <label for="user-address" class="am-form-label">所在地</label>
                                            <div class="am-form-content address" id='address'>
                                                <select  level='province'>
                                                    <option value="a">--请选择--</option>
                                                    {% for i in address %}
                                                    <option value="{{i.id}}">{{i.name}}</option>
                                                    {% endfor %}
                                                </select>
                                                <select level='shi'>
                                                    <option value="a">--请选择--</option>
                                                </select>
                                                <select level='quxian' id='quxian'>
                                                    <option value="a">--请选择--</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="am-form-group">
                                            <label for="user-intro" class="am-form-label">详细地址</label>
                                            <div class="am-form-content">
                                                <textarea class="" rows="3" id="user-intro" placeholder="输入详细地址"></textarea>
                                                <small>100字以内写出你的详细地址...</small>
                                            </div>
                                        </div>

                                        <div class="am-form-group">
                                            <div class="am-u-sm-9 am-u-sm-push-3">
                                                <a class="am-btn am-btn-danger" id="addsave" href="javascript: void(0)">保存</a>
                                                <a href="javascript: void(0)" class="am-close am-btn am-btn-danger" data-am-modal-close>取消</a>
                                            </div>
                                        </div>
                                    </form>
                                </div>

                            </div>

                        </div>

                    </div>



                    <div class="clear" style="margin-bottom:30px"></div>

                </div>
            </div>


            <aside class="menu">
                <ul>
                    <li class="person active">
                        <a href="#"><i class="am-icon-user"></i>个人中心</a>
                    </li>
                    <li class="person">
                        <p><i class="am-icon-newspaper-o"></i>个人资料</p>
                        <ul>
                            <li> <a href="{% url 'myhome_information' %}?phone={{request.session.vipuser.phone}}">个人信息</a></li>
                            <li> <a href="{% url 'addresslist' %}">地址管理</a></li>
                        </ul>
                    </li>
                    <li class="person">
                        <p><i class="am-icon-balance-scale"></i>我的交易</p>
                        <ul>
                            <li><a href="{% url 'myhome_ordero' %}">订单管理</a></li>
                        </ul>
                    </li>
                </ul>

            </aside>
        </div>
                <div class="theme-popover-mask"></div>
            <div class="theme-popover">

                <!--标题 -->
                <div class="am-cf am-padding">
                    <div class="am-fl am-cf"><strong class="am-text-danger am-text-lg">新增地址</strong> / <small>Add address</small></div>
                </div>
                <hr/>

                <div class="am-u-md-12">
                    <form class="am-form am-form-horizontal hform" method='post' action="{% url 'addressedit' %}">
                        {% csrf_token %}
                        <input type="hidden" id="hidden" name="aid" >
                        <div class="am-form-group">
                            <label for="user-name" class="am-form-label">收货人</label>
                            <div class="am-form-content">
                                <input type="text" name="name" id="username-h" placeholder="收货人">
                            </div>
                        </div>

                        <div class="am-form-group">
                            <label for="user-phone" class="am-form-label">手机号码</label>
                            <div class="am-form-content">
                                <input id="user-phone-h" name="phone" placeholder="手机号必填" type="email">
                            </div>
                        </div>

                        <div class="am-form-group">
                            <label for="user-phone" class="am-form-label">所在地</label>
                            <div class="am-form-content address" id="address-h">
                                <select name='sheng' level="province-h">
                                    <option value="a">--请选择--</option>
                                    {% for i in address %}
                                    <option value="{{i.id}}">{{i.name}}</option>
                                    {% endfor %}
                                    
                                </select>
                                <select name="shi" level="shi-h">
                                    <option value="a">--请选择--</option>
                                    {% for i in addresss %}
                                    <option value="{{i.id}}">{{i.name}}</option>
                                    {% endfor %}
                                </select>
                                <select name="quxian" level="quxian-h" id='quxian-h'>
                                    <option value="a">--请选择--</option>
                                    {% for i in addresst %}
                                    <option value="{{i.id}}">{{i.name}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="am-form-group">
                            <label for="user-intro" class="am-form-label">详细地址</label>
                            <div class="am-form-content">
                                <textarea name="info" class="" rows="3" id="user-intro-h" placeholder="输入详细地址"></textarea>
                                <small>100字以内写出你的详细地址...</small>
                            </div>
                        </div>

                        <div class="am-form-group theme-poptit">
                            <div class="am-u-sm-9 am-u-sm-push-3">
                                <div class="am-btn am-btn-danger" id='addsave-h'>保存</div>
                                <div class="am-btn am-btn-danger close">取消</div>
                            </div>
                        </div>
                    </form>
                </div>

            </div>

            <div class="clear"></div>

<script type="text/javascript">

// 弹出地址选择
 
            $(document).ready(function($) {
    
                var $ww = $(window).width();
    
                $('#ul').on('click','.editaddress',function() {
//                  禁止遮罩层下面的内容滚动
                    var aid = $(this).parents('li').attr('data')
                    $.get('{% url "addressedit" %}',{'aid':aid},function(data){
                        if(data['error']==0){
                            console.log('232')
                            $('#username-h').val(data['aob']['name'])
                            $('#user-phone-h').val(data['aob']['phone'])
                            $('select[level=province-h]').val(data['aob']['shengid'])
                            $("select[level=shi-h]").val(data['aob']['shiid'])
                            $('#quxian-h').val(data['aob']['xqid'])
                            $('#user-intro-h').val(data['aob']['info'])
                            $('#hidden').val(aid)
                        }
                    })
                    // 给表单设置内容
                    $(this).addClass("selected");
                    $(this).parent().addClass("selected");

                                    
                    $('.theme-popover-mask').show();
                    $('.theme-popover-mask').height($(window).height());
                    $('.theme-popover').slideDown(200);                                                                     
                    
                })
                
                // 修改地址的提交事件
                $('#addsave-h').click(function(){
                    var name = $('#username-h').val()
                    var phone = $('#user-phone-h').val()
                    var aid = $('#hidden').val()
                    var sheng = $('select[level=province-h]').val()
                    var shi = $('select[level=shi-h]').val()
                    var city = $('#quxian-h').val()
                    var info = $('#user-intro-h').val()
                    if(sheng=='a'){alert('城市地址未选择.');return false}
                    if(shi=='a'){alert('城市地址未选择.');return false}
                    if(city=='a'){alert('城市地址未选择.');return false}
                    if(!phone){alert('电话不能为空!');return false}
                    if(!info){alert('详细内容不能为空!');return false}
                    if(!name){alert('收货人不能为空!');return false}
                    // $.post('{% url "addressedit" %}',{'name':name,'phone':phone,'city':city,'info':info,'aid':aid},function(data){
                    //  if(data['error']==0){
                    //      alert('成功')
                    //  }
                    // }
                    $('.hform').submit()

                    $(document.body).css("overflow","visible");
                    $('.theme-login').removeClass("selected");
                    $('.item-props-can').removeClass("selected");                   
                    $('.theme-popover-mask').hide();
                    $('.theme-popover').slideUp(200);
                })
                $('.theme-poptit .close,.btn-op .close').click(function() {

                    $(document.body).css("overflow","visible");
                    $('.theme-login').removeClass("selected");
                    $('.item-props-can').removeClass("selected");                   
                    $('.theme-popover-mask').hide();
                    $('.theme-popover').slideUp(200);
                })

                
            });
    // 设为默认
    $('#ul').on('click','.new-option-r',function(){
        if($(this).text()=='默认地址'){
            return
        }else{
            var aid = $(this).parents('li').attr('data')
            $.get('{% url "myhome_defaultedit" %}',{'aid':aid},function(data){
                if(data['error']==0){}
                else{alert('修改失败');return false}
            })
            $(this).text('默认地址')
            $(this).parents('li').siblings().find('.new-option-r').text('设为默认')
        }
    })
    $(document).ready(function() {                          
        $(".user-addresslist").click(function() {
            $(this).addClass("defaultAddr").siblings().removeClass("defaultAddr");
        });
        
        var $ww = $(window).width();
        if($ww>640) {
            $("#doc-modal-1").removeClass("am-modal am-modal-no-btn")
        }
        
    })
    // 删除地址
    $('#ul').on('click','.deladdress',function(){
        var el = $(this)
        console.log(1111)
        if(el.parents('li').attr('class')=='user-addresslist defaultAddr'){
            alert('默认地址不能删除.请先更改默认地址.')
            return
        }
        $.get('{% url "myhome_deladdress" %}',{'aid':$(this).parents('li').attr('data')},function(data){
        if(data['error']==1){
            alert('删除失败');
        }else{
            alert('删除成功');
            el.parents('li').remove();
        }
    })
    })
    // 地址联动
    $('#address select').click(function(){
        if($(this).attr('level')=='quxian'){
            return
        }
        if($(this).val()=='a'){
            return;
        }
        var el = $(this)
        var cid = $(this).val()
        var opn = ''
        $.get('{% url "myhome_addresss" %}',{'cid':cid},function(data){
            for (var i=0;i<data.length;i++){
                opn += '<option value="'+data[i].id+'">'+data[i].name+'</option>'
            }
            el.next().html(opn);
        })
    })
    $('#address-h select').click(function(){
        if($(this).attr('level')=='quxian-h'){
            return
        }
        if($(this).val()=='a'){
            return;
        }
        var el = $(this)
        var cid = $(this).val()
        var opn = ''
        $.get('{% url "myhome_addresss" %}',{'cid':cid},function(data){
            for (var i=0;i<data.length;i++){
                opn += '<option value="'+data[i].id+'">'+data[i].name+'</option>'
            }
            el.next().html(opn);
        })
    })
    // 地址保存
    $('#addsave').click(function(){
        var name = $('#username').val()
        if(!name){alert('收货人不能为空!');return false}
        var phone = $('#user-phone').val()
        if(!phone){alert('电话不能为空!');return false}
        var sheng = $('select[level=province]').val()
        var shi = $('select[level=shi]').val()
        var city = $('#quxian').val()
        if(sheng=='a'){alert('城市地址未选择.');return false}
        if(shi=='a'){alert('城市地址未选择.');return false}
        if(city=='a'){alert('城市地址未选择.');return false}
        var info = $('#user-intro').val()
        if(!info){alert('详细内容不能为空!');return false}
        $.get('{% url "myhome_addresssadd" %}',{'name':name,'phone':phone,'city':city,'info':info},function(data){
            // 成功后将内容写入 并清空表单
            if(data['error']==1){
                alert('添加成功')
                $('.theme-popover-mask').css('display','none')
                $('.theme-popover').css('display','none')
                var li = $('#ul li').eq(0).clone()
                li.removeClass('hidden')
                li.find('.new-txt').text(name)
                li.find('.buy-phone').text(phone)
                li.find('.province').text(data['area']['sheng'])
                li.find('.city').text(data['area']['shi'])
                li.find('.dist').text(data['area']['xq'])
                li.find('.street').text(info)
                li.find('.new-option-r').text('设为默认')
                li.attr('data',data['area']['id'])
                li.removeClass('defaultAddr')
                $('#ul').append(li)
                $('body').css('overflow-y','scroll')
                $('#user-intro').val('')
                $('#quxian').val('a')
                $('select[level=shi]').val('a')
                $('select[level=province]').val('a')
                $('#user-phone').val('')
                $('#username').val('')
            }else{
                alert('添加失败')
            }
        })
    })
</script>

{% endblock %}